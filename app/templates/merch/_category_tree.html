{# Recursive category + products tree #}

<div class="card mb-3">
  <div class="card-body d-flex align-items-center justify-content-between" style="gap:.5rem;">
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <strong>{{ node.name }}</strong>
      {% if node.order %}<span class="text-muted small">Â· Order: {{ node.order }}</span>{% endif %}
      {% if node.parent %}<span class="badge text-bg-light">Child of {{ node.parent.name }}</span>{% endif %}
    </div>

    {# All four actions in ONE btn-group, single line #}
    <div class="btn-group btn-group-sm flex-nowrap" role="group" aria-label="Category actions" style="flex-shrink:0;">
      <a class="btn btn-outline-success"
         href="{% url 'merch:category_new' %}?parent={{ node.pk }}">+ Subcategory</a>
      <a class="btn btn-outline-primary"
         href="{% url 'merch:product_create' %}?category={{ node.pk }}">+ Item here</a>
      <a class="btn btn-outline-secondary"
         href="{% url 'merch:category_edit' node.pk %}">Edit</a>
      <form method="post"
            action="{% url 'merch:category_delete' node.pk %}"
            class="d-inline-block"
            onsubmit="return confirm('Delete category {{ node.name }}?');">
        {% csrf_token %}
        <button class="btn btn-danger">Delete</button>
      </form>
    </div>
  </div>

  {# Products directly under this category #}
  {% if node.products.all %}
    <div class="list-group list-group-flush">
      {% for p in node.products.all %}
        <div class="list-group-item d-flex align-items-center justify-content-between" style="gap:.75rem;">
          <div class="d-flex align-items-center" style="gap:.75rem;">
            {% if p.primary_image %}
              <img src="{{ p.primary_image.image.url }}"
                   alt="{{ p.primary_image.alt_text }}"
                   style="height:48px;width:48px;object-fit:cover;border-radius:6px;">
            {% endif %}
            <div>
              <div class="fw-semibold">{{ p.name }}</div>
              <div class="small text-muted">
                {% if p.base_price %}{{ p.base_price }}
                {% else %}
                  {% with m=p.min_variant_price %}{% if m %}from {{ m }}{% endif %}{% endwith %}
                {% endif %}
                {% if not p.visible_public %}<span class="badge text-bg-warning ms-1">Hidden</span>{% endif %}
                {% if p.featured %}<span class="badge text-bg-info ms-1">Featured</span>{% endif %}
              </div>
            </div>
          </div>

          {# Edit + Delete as siblings in ONE group #}
          <div class="btn-group btn-group-sm flex-nowrap" role="group" style="flex-shrink:0;">
            <a class="btn btn-outline-secondary" href="{% url 'merch:product_edit' p.slug %}">Edit</a>
            <form method="post"
                  action="{% url 'merch:product_delete' p.slug %}"
                  class="d-inline-block"
                  onsubmit="return confirm('Delete {{ p.name }}?');">
              {% csrf_token %}
              <button class="btn btn-danger">Delete</button>
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {# Render child categories recursively #}
  {% if node.children.all %}
    <div class="card-body pt-2">
      {% for child in node.children.all %}
        {% include "merch/_category_tree.html" with node=child only %}
      {% endfor %}
    </div>
  {% endif %}
</div>
